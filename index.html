<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice AI Chat</title>
  <style>
    #voiceBtn { width:100px; height:100px; border-radius:50%; font-size:2rem; cursor:pointer; }
    #status { margin-top:1rem; font-family:sans-serif; }
  </style>
</head>
<body>
  <button id="voiceBtn">🎤</button>
  <div id="status">Idle</div>

<script>
const btn = document.getElementById('voiceBtn');
const status = document.getElementById('status');

let state = 'idle';
let mainRec, bgRec, utterance;

function init() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    status.textContent = 'Web Speech API not supported';
    btn.disabled = true;
    return;
  }
  mainRec = new SR();
  bgRec   = new SR();

  [mainRec, bgRec].forEach(r => {
    r.continuous = true;
    r.interimResults = false;
    r.lang = 'en-US';
  });

  mainRec.onresult = e => {
    const txt = e.results[e.resultIndex][0].transcript.trim();
    if (txt) handleUser(txt);
  };
  mainRec.onend = () => { if (state === 'listening') mainRec.start(); };

  bgRec.onresult = () => {
    if (state === 'speaking') stopSpeaking(true);
  };
}

function updateUI() {
  const icons = { idle:'🎤', listening:'🔴', speaking:'🗣️' };
  btn.textContent = icons[state];
  status.textContent = state.charAt(0).toUpperCase() + state.slice(1);
}

function startListening(){
  state = 'listening';
  mainRec.start();
  updateUI();
}

function stopListening(){
  state = 'idle';
  mainRec.stop();
  updateUI();
}

function handleUser(text){
  stopListening();
  console.log("User:", text);
  const url = 'https://auto.mithil.hackclub.app/webhook/parse-voice?text=${encodeURIComponent(text)}';
  fetch(url, { method:'GET' })
    .then(r => r.json())
    .then(data => speak(data.reply))
    .catch(err => {
      console.error(err);
      state='idle';
      updateUI();
    });
}

function speak(txt){
  utterance = new SpeechSynthesisUtterance(txt);
  utterance.lang = 'en-US';
  state = 'speaking';
  updateUI();

  utterance.onstart = () => bgRec.start();
  utterance.onend   = () => {
    bgRec.stop();
    state = 'idle';
    updateUI();
    startListening();
  };

  speechSynthesis.speak(utterance);
}

function stopSpeaking(interrupted=false){
  speechSynthesis.cancel();
  bgRec.stop();
  state = 'idle';
  updateUI();
  startListening();
}

btn.addEventListener('click', () => {
  if (state === 'idle') startListening();
  else if (state === 'listening') stopListening();
  else if (state === 'speaking') stopSpeaking(true);
});

init();
updateUI();
</script>
</body>
</html>
